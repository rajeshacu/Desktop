<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LoRa Tracker Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="leaflet/leaflet.css" />
  <style>
    :root {
      --bg-color: #f5f7fb;
      --card-bg: #ffffff;
      --accent: #007bff;
      --text: #333;
    }

    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-color);
    }

    #map {
      height: 50%;
    }

    .dashboard {
      height: 50%;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      padding: 12px;
      box-sizing: border-box;
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      animation: fadeInUp 0.5s ease;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-size: 0.9rem;
      color: #666;
    }

    .card-value {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--text);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0px);
      }
    }

    .battery-bar {
      width: 100%;
      height: 10px;
      border-radius: 5px;
      background: #e0e0e0;
      overflow: hidden;
      margin-top: 6px;
    }

    .battery-fill {
      height: 100%;
      background-color: #28a745;
      transition: width 0.3s ease;
    }

    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    .card:nth-child(4) { animation-delay: 0.4s; }
    .card:nth-child(5) { animation-delay: 0.5s; }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="dashboard">
    <div class="card">
      <div class="card-title">Device ID</div>
      <div class="card-value" id="id">--</div>
    </div>
    <div class="card">
      <div class="card-title">Temperature (°C)</div>
      <div class="card-value" id="temperature">--</div>
    </div>
    <div class="card">
      <div class="card-title">Pressure (hPa)</div>
      <div class="card-value" id="pressure">--</div>
    </div>
    <div class="card">
      <div class="card-title">Altitude (m)</div>
      <div class="card-value" id="altitude">--</div>
    </div>
    <div class="card">
      <div class="card-title">Battery (%)</div>
      <div class="card-value" id="battery">--</div>
      <div class="battery-bar"><div id="battery-fill" class="battery-fill" style="width: 0%"></div></div>
    </div>
  </div>

  <script src="leaflet/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([12.961, 77.598], 16);

    L.tileLayer('./tiles/{z}/{x}/{y}.png', {
      maxZoom: 18,
      minZoom: 12,
      attribution: 'Offline Map',
    }).addTo(map);

    const customIcon = L.icon({
      iconUrl: 'images/marker-icon-red.png',
      shadowUrl: 'images/marker-shadow.png',
      iconSize: [25, 41],
      shadowSize: [41, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });

    let lines = [];
    let index = 0;
    let marker = null;

    async function loadData() {
      try {
        const res = await fetch('data.txt?_=' + Date.now());
        const text = await res.text();
        lines = text.trim().split('\n');
        startAnimation();
      } catch (err) {
        console.error('Failed to load data.txt:', err);
      }
    }

    function updateUI(data) {
      document.getElementById('id').textContent = data.id || '--';
      document.getElementById('temperature').textContent = data.temperature || '--';
      document.getElementById('pressure').textContent = data.pressure || '--';
      document.getElementById('altitude').textContent = data.altitude || '--';
      document.getElementById('battery').textContent = data.battery || '--';

      const fill = document.getElementById('battery-fill');
      const battery = parseInt(data.battery);
      fill.style.width = battery + '%';

      if (battery > 60) fill.style.background = '#28a745';
      else if (battery > 30) fill.style.background = '#ffc107';
      else fill.style.background = '#dc3545';
    }

    function startAnimation() {
      if (lines.length === 0) return;

      const interval = setInterval(() => {
        if (index >= lines.length) {
          clearInterval(interval);
          return;
        }

        try {
          const data = JSON.parse(lines[index]);
          const lat = parseFloat(data.latitude);
          const lon = parseFloat(data.longitude);

          if (!isNaN(lat) && !isNaN(lon)) {
            updateUI(data);

            const popup = `
              <b>ID:</b> ${data.id}<br/>
              <b>Temp:</b> ${data.temperature} °C<br/>
              <b>Pressure:</b> ${data.pressure} hPa<br/>
              <b>Altitude:</b> ${data.altitude} m<br/>
              <b>Battery:</b> ${data.battery}%
            `;

            if (!marker) {
              marker = L.marker([lat, lon], { icon: customIcon }).addTo(map).bindPopup(popup).openPopup();
            } else {
              marker.setLatLng([lat, lon]).setPopupContent(popup).openPopup();
            }

            map.panTo([lat, lon]);
          }
        } catch (e) {
          console.warn("Invalid JSON at line", index + 1);
        }

        index++;
      }, 3000);
    }

    loadData();
  </script>

</body>
</html>

